name: Weekly AWS Updates

on:
  schedule:
    # 毎週月曜日 JST 1:00 AM (UTC 16:00 日曜日)
    - cron: '0 16 * * 0'
  workflow_dispatch: # 手動実行も可能

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    
    - name: Setup locale and install dependencies
      run: |
        # Install Japanese locale
        sudo apt-get update
        sudo apt-get install -y locales language-pack-ja
        sudo locale-gen ja_JP.UTF-8
        sudo update-locale LANG=ja_JP.UTF-8
        
        # Install Python dependencies
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      env:
        LANG: ja_JP.UTF-8
        LC_ALL: ja_JP.UTF-8
    
    - name: Generate AWS updates report
      run: |
        # Set Japanese locale for the script
        export LANG=ja_JP.UTF-8
        export LC_ALL=ja_JP.UTF-8
        
        # Add delay to avoid rate limiting
        python aws_updates_summary_improved.py
      env:
        LANG: ja_JP.UTF-8
        LC_ALL: ja_JP.UTF-8
        PYTHONIOENCODING: utf-8
    
    - name: Prepare docs for GitHub Pages
      run: |
        mkdir -p docs
        cp output/*.md docs/ 2>/dev/null || true
        
        CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S JST')
        
        cat > docs/index.md << 'INDEXEND'
        ---
        layout: default
        title: AWS Updates Summary
        ---
        
        # 🚀 AWS Updates Summary
        
        AWSの週次アップデート情報レポート
        
        ## 📋 レポート一覧
        
        INDEXEND
        
        for file in $(ls -t docs/awsupdates_*.md 2>/dev/null); do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            date_part=$(echo "$filename" | sed 's/awsupdates_\([0-9-]*\)_\([0-9-]*\).md/\1 〜 \2/')
            echo "- [$date_part]($filename)" >> docs/index.md
          fi
        done
        
        echo "" >> docs/index.md
        echo "---" >> docs/index.md
        echo "" >> docs/index.md
        echo "**最終更新**: $CURRENT_DATE" >> docs/index.md
        echo "" >> docs/index.md
        echo "[📁 GitHubリポジトリ](https://github.com/98lerr/aws-updates)" >> docs/index.md

    - name: Create Jekyll config
      run: |
        cat > docs/_config.yml << 'CONFIGEND'
        title: AWS Updates Summary
        description: AWSの週次アップデート情報を自動収集・翻訳・分類
        theme: minima
        plugins:
          - jekyll-feed
          - jekyll-sitemap
        
        markdown: kramdown
        highlighter: rouge
        
        github:
          repository_name: aws-updates
          repository_url: https://github.com/98lerr/aws-updates
        
        sass:
          sass_dir: _sass
          style: compressed
        CONFIGEND

    - name: Create custom CSS
      run: |
        mkdir -p docs/_sass
        mkdir -p docs/assets/css
        
        cat > docs/_sass/custom.scss << 'CSSEND'
        $aws-orange: #FF9900;
        $aws-dark-blue: #232F3E;
        $aws-light-blue: #0073bb;
        
        .site-header {
          background-color: $aws-dark-blue;
          border-bottom: 3px solid $aws-orange;
        }
        
        .site-title, .site-title:visited {
          color: white !important;
        }
        
        h1 {
          color: $aws-dark-blue;
          border-bottom: 2px solid $aws-orange;
          padding-bottom: 10px;
        }
        
        h2 {
          color: $aws-dark-blue;
          background: #f8f9fa;
          padding: 10px;
          border-left: 4px solid $aws-orange;
          margin-top: 30px;
        }
        
        h3 {
          color: $aws-light-blue;
        }
        
        h4 {
          color: #333;
        }
        
        a {
          color: $aws-light-blue;
        }
        
        a:hover {
          color: darken($aws-light-blue, 10%);
        }
        
        strong {
          color: #d63384;
        }
        
        .post-content ul li {
          margin: 8px 0;
        }
        
        .stats {
          background: #e7f3ff;
          padding: 15px;
          border-radius: 5px;
          margin: 20px 0;
        }
        
        .toc {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 5px;
          margin: 20px 0;
        }
        
        .toc ul {
          list-style-type: none;
          padding-left: 0;
        }
        
        .toc li {
          margin: 5px 0;
        }
        CSSEND
        
        cat > docs/assets/css/style.scss << 'STYLEEND'
        ---
        ---
        
        @import "minima";
        @import "custom";
        STYLEEND

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages
        enable_jekyll: true